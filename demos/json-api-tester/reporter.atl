// Reporter module - Results reporting and formatting
import { writeFile } from "std:io";
import { pathJoin } from "std:path";
import { toJSON, prettifyJSON } from "std:json";
import { timestampNow, formatIso } from "std:datetime";

// Display test results summary
export fn displaySummary(results: array, totalTests: number) -> void {
    let passed: number = 0;
    let failed: number = 0;
    let totalDuration: number = 0;

    for result in results {
        let isPassed: bool = jsonAsBool(result["passed"]);
        let duration: number = jsonAsNumber(result["duration"]);

        if (isPassed) {
            passed = passed + 1;
        } else {
            failed = failed + 1;
        }

        totalDuration = totalDuration + duration;
    }

    print("");
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    print("  Test Results Summary");
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    print("  Total:    " + toString(totalTests));
    print("  Passed:   " + toString(passed) + " âœ…");
    print("  Failed:   " + toString(failed) + " âŒ");
    print("  Duration: " + toString(totalDuration) + "ms");
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    print("");
}

// Display individual test result
export fn displayTestResult(result: JsonValue, index: number) -> void {
    let name: string = jsonAsString(result["name"]);
    let passed: bool = jsonAsBool(result["passed"]);
    let duration: number = jsonAsNumber(result["duration"]);

    let status: string = if (passed) { "âœ… PASS" } else { "âŒ FAIL" };
    print(toString(index) + ". " + status + " - " + name + " (" + toString(duration) + "ms)");

    // Show error if failed
    let error: JsonValue = result["error"];
    if (!jsonIsNull(error)) {
        print("   Error: " + jsonAsString(error));
    }

    // Show failed assertions
    let assertions: JsonValue = result["assertions"];
    if (!jsonIsNull(assertions) && jsonIsArray(assertions)) {
        let assertArr: array = jsonAsArray(assertions);
        for assertion in assertArr {
            let assertPassed: bool = jsonAsBool(assertion["passed"]);
            if (!assertPassed) {
                let assertType: string = jsonAsString(assertion["type"]);
                let message: string = jsonAsString(assertion["message"]);
                print("   Assertion failed (" + assertType + "): " + message);
            }
        }
    }
}

// Save results to JSON file
export fn saveResults(results: array, suiteName: string) -> Result<void, string> {
    let timestamp: number = timestampNow();
    let filename: string = suiteName + "-" + toString(timestamp) + ".json";
    let filepath: string = pathJoin(["./results", filename]);

    let report: JsonValue = jsonObject([
        ["suite", jsonString(suiteName)],
        ["timestamp", jsonNumber(timestamp)],
        ["results", jsonArray(results)]
    ]);

    let json: string = prettifyJSON(report);
    let writeResult: Result<void, string> = writeFile(filepath, json);

    match writeResult {
        Ok(_) => {
            print("ğŸ“„ Results saved to: " + filepath);
            return Ok(void);
        },
        Err(e) => return Err("Failed to save results: " + e)
    }
}

// Display progress indicator
export fn displayProgress(current: number, total: number, testName: string) -> void {
    print("ğŸ§ª [" + toString(current) + "/" + toString(total) + "] Running: " + testName);
}

// Display test suite header
export fn displaySuiteHeader(suiteName: string, description: string, totalTests: number) -> void {
    print("");
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    print("â•‘  API Test Suite: " + suiteName);
    print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    print("â•‘  " + description);
    print("â•‘  Tests: " + toString(totalTests));
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    print("");
}
